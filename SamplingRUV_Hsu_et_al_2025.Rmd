---
title: "SamplingRUV (Hsu et al. 2025)"
author: "Tsai-Hsuan Tony Hsu"
date: "`r Sys.Date()` (year/month/date)"
output: 
  html_document:
    toc_float: true
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Data and R markdown to replicate analyses in Hsu et al. (2025). If used in full or in part, please cite the data and the original publication:

Publication:
Hsu T-H.T, Gordon S, Rerrari R, Hoey A.S, Figueira W.F (in press) Optimizing remote underwater video sampling to quantify relative abundance, richness, and corallivory rates of reef fish. *Coral Reefs*. [https://doi.org/10.1007/s00338-024-02613-6](https://doi.org/10.1007/s00338-024-02613-6)

Data and R markdown:
Hsu T-H.T, Gordon S, Rerrari R, Hoey A.S, Figueira W.F (2025) Data and R markdown to replicate analyses in “Optimizing remote underwater video sampling to quantify relative abundance, richness, and corallivory rates of reef fish”. *Sydney eScholarship*, [https://doi.org/10.25910/agvq-3f82](https://doi.org/10.25910/agvq-3f82)


Data and R markdown also available on [Sydney eScholarship](https://hdl.handle.net/2123/33520) and [GitHub](https://github.com/THTonyHsu/SamplingRUV.git)

# **Packages**

```{r eval = TRUE, echo=T, message=F, warning=F}
library(reshape)
library(stringr)
library(iNEXT)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(cowplot)
library(grid)
```

# **Dataset**

```{r eval = TRUE, echo=T, message=F, warning=F}
# Intensive sampling datasets
dfc = list()
dfc[["Aukane"]] = read.csv("./Data/Hsuetal_dataset_PM_Aukane.csv")
dfc[["Chicken"]] = read.csv("./Data/Hsuetal_dataset_PM_Chicken.csv")
dfc[["Heron"]] = read.csv("./Data/Hsuetal_dataset_PM_Heron.csv")
# Bite rates data
FR_Masig = read.csv("./Data/Hsuetal_dataset_FR_Masig.csv")
FR_Lizard = read.csv("./Data/Hsuetal_dataset_FR_Lizard.csv")
FR_Pelorus = read.csv("./Data/Hsuetal_dataset_FR_Pelorus.csv")
FR_Davies = read.csv("./Data/Hsuetal_dataset_FR_Davies.csv")
FR_Halfway = read.csv("./Data/Hsuetal_dataset_FR_Halfway.csv")
FR_Heron = read.csv("./Data/Hsuetal_dataset_FR_Heron.csv")
# Species list for obligate corallivore (Cole et al., 2008)
Oblcoral = read.csv("./Data/Hsuetal_dataset_Obligate corallivorous fish.csv", header = T)
```

# **Optimizing sampling for MeanCount**

## Raw counts of fish individuals
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 5, fig.width = 8}
S3 = factor(c("Aukane", "Chicken", "Heron"), levels = c("Aukane", "Chicken", "Heron"))
col3 = c("#b35806", "#998ec3", "#542788")

# convert intensive sampling datasets to wide format & aggregate data for each species
for (n in 1:3) {
  dfc[[n]] = as.data.frame(cast(dfc[[n]], Frame ~ SN, value = "Number", fun.aggregate = sum))
  dfc[[n]] = dfc[[n]][,-1]
  }

# Covert count data to presence & absence
dfc_r = dfc
for (n in 1:3) {
  dfc_r[[n]][dfc_r[[n]]>0] = 1
}

# Generate functions for SE & RSE
SE = function(x){sd(na.omit(x))/sqrt(length(na.omit(x)))} # Standard error (SE)
RSE = function(x){SE(x)/mean(x, na.rm = T)*100} # Relative standard error (RSE)

# Raw counts in each frames
RawC = data.frame(
  Site = rep(S3, each = 360),
  Count = (lapply(dfc, FUN = rowSums) %>% unlist() %>% as.numeric()),
  Frame = rep(1:360, 3)
)
RawC$Site = factor(RawC$Site, levels = S3)

# Figure S1: Raw counts of fish individuals
FigS1 = ggplot(RawC, aes(x = Frame, y = Count, col = Site))+
  geom_line(linewidth = 0.8)+
  theme(plot.title = element_blank(),
        axis.text = element_text(colour = "black", face = "bold", size = 12),
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank())+
  labs(x = "Frames", y = "Number of individuals")+
  scale_color_manual(values = col3)+
  scale_x_continuous(breaks = c(seq(0, 360, 60)))

FigS1

```

## How many frames for MeanCount
```{r eval = TRUE, echo=T, message=F, warning=F}
# Create an empty list for storing randomly computed MeanCount for each site
# Row: repetition; Col: number of random frames from 1 to 360
RM_MC = list(Aukane = as.data.frame(matrix(nrow = 1000, ncol = 360)),
                Chicken = as.data.frame(matrix(nrow = 1000, ncol = 360)),
                Heron = as.data.frame(matrix(nrow = 1000, ncol = 360)))

# Random sampling with replacement
set.seed(123) # ensure reproducibility
for (n in 1:3) { # for each site
  for (j in 1:360) { # for j no. of random frames
    for (i in 1:1000) { # bootstrapping for 1,000 times
      RM_MC[[n]][i,j] = sum(dfc[[n]][sample(1:360, size = j, replace = T),])/j
    }
  }}

# Create an empty data frame for summary statistics of random MeanCount
dp_MC = data.frame(
  Site = rep(S3, each = 360),
  x = rep(1:360, 3),
  Mean = rep(NA, 1080),
  RSE = rep(NA, 1080))

# Compute mean & RSE (precision) of the 1,000 random MeanCount
for (n in 1:3) {
  dp_MC$Mean[(1+360*(n-1)):(360+360*(n-1))] = apply(RM_MC[[n]], 2, mean) # Average of the 1,000 random MeanCount
  dp_MC$RSE[(1+360*(n-1)):(360+360*(n-1))] = apply(RM_MC[[n]], 2, RSE) # RSE of the 1,000 random MeanCount
}
# Compute accuracy of the random MeanCount
dp_MC %>% group_by(Site) %>% filter(x == 360) %>% select(Site, Mean) %>% rename(GT = Mean) %>% left_join(dp_MC, .) %>% group_by(Site, x) %>% mutate(Accuracy = (Mean-GT)/GT*100) -> dp_MC

# Find the frame where RSE dropped below 0.5%
dp_MC %>% group_by(Site) %>% filter(RSE < 0.5) %>% summarise(Minf = min(x))
dp_MC %>% filter(Site == "Aukane" & x == 12)
dp_MC %>% filter(Site == "Chicken" & x == 10)
dp_MC %>% filter(Site == "Heron" & x == 37)

# Calculate the slope changes of RSE
dp_MC$RSE_1 = c(NA, dp_MC$RSE[1:359], NA, dp_MC$RSE[361:719], NA, dp_MC$RSE[721:1079])
dp_MC$RSE_1 = (dp_MC$RSE-dp_MC$RSE_1)

# Find the frame where slope changes of RSE dropped below 0.05%
dp_MC %>% group_by(Site) %>% filter(abs(RSE_1) < 0.05) %>% summarise(Minf = min(x))

# Calculate the slope changes of deviation
dp_MC$Accuracy_1 = c(NA, dp_MC$Accuracy[1:359], NA, dp_MC$Accuracy[361:719], NA, dp_MC$Accuracy[721:1079])
dp_MC$Accuracy_1 = (dp_MC$Accuracy-dp_MC$Accuracy_1)

# Find the frame where slope changes of deviation dropped below 0.05%
dp_MC %>% group_by(Site) %>% filter(abs(Accuracy_1) < 0.05) %>% summarise(Minf = min(x))

dp_MC %>% filter(Site == "Aukane" & x == 15)
dp_MC %>% filter(Site == "Chicken" & x == 17)
dp_MC %>% filter(Site == "Heron" & x == 31)
```

### Plotting
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 6, fig.width = 12.5}
# Precision
p_MC_RSE = ggplot(dp_MC, aes(x = x, y = RSE, col = Site))+
  geom_point()+
  theme(plot.title = element_text(face = "bold", size = (15), hjust = 0.5),
        axis.text = element_text(colour = "black", face = "bold", size = 12),
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank())+
  labs(x = "No. of random frames", y = "RSE (%)", title = "Precision of MeanCount")+
  scale_color_manual(values = col3)+
  scale_x_continuous(breaks = c(seq(0, 100, 20), seq(150, 300, 50), 360), expand = c(0,5))+
  scale_y_continuous(breaks = seq(0, 3.2, 0.5), expand = c(0, 0, 0, 0.1))+
  geom_vline(xintercept = 40, linetype = "dotdash")+
  geom_hline(yintercept = 0.5, linetype = "dotdash")
# Precision (inset)
p_MC_RSE_in = p_MC_RSE + xlim(0, 45)+ 
  # geom_smooth(method="nls", se=FALSE, formula=y~a*log(x)+k,
  #             method.args=list(start=c(a=1, k=1)))+
  theme(plot.title = element_blank(),
        axis.title = element_blank(),
        legend.position = "none")+
  geom_hline(yintercept = 0.5, linetype = "dotdash")

p_MC_RSE_in = ggdraw() +
  draw_plot(p_MC_RSE + theme(legend.position="none", plot.title = element_blank())) +
  draw_plot(p_MC_RSE_in, x = 0.35, y = 0.5, width = .6, height = .4 )

# Accuracy
p_MC_Dev = ggplot(dp_MC, aes(x = x, y = abs(Accuracy), col = Site))+
  geom_point()+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12),
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank())+
  labs(x = "No. of random frames", y = "Absolute deviation (%)")+
  scale_color_manual(values = col3)+
  scale_x_continuous(breaks = c(seq(0, 100, 20), seq(150, 300, 50), 360), expand = c(0,5))+
  scale_y_continuous(breaks = c(seq(-2.5, 5.5, 1), 0), expand = c(0, 0, 0, 0.1))+
  geom_vline(xintercept = 40, linetype = "dotdash")+
  geom_hline(yintercept = 0.5, linetype = "dotdash")+
  stat_smooth(method = "lm", formula = y ~ log(x))

# Accuracy (inset)
p_MC_Dev_in = ggplot(dp_MC, aes(x = x, y = abs(Accuracy), col = Site))+
  geom_point()+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12),
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank())+
  labs(x = "No. of random frames", y = "Absolute deviation (%)")+
  scale_color_manual(values = col3)+
  scale_x_continuous(breaks = c(seq(0, 100, 20), seq(150, 300, 50), 360), expand = c(0,5))+
  scale_y_continuous(breaks = c(seq(-2.5, 5.5, 1), 0), expand = c(0, 0, 0, 0.1))+
  geom_vline(xintercept = 40, linetype = "dotdash")+
  geom_hline(yintercept = 0.5, linetype = "dotdash")+
  stat_smooth(method = "lm", formula = y ~ log(x))+ 
  xlim(0, 45)+
  theme(plot.title = element_blank(),
        axis.title = element_blank(),
        legend.position = "none")+
  geom_hline(yintercept = 0.5, linetype = "dotdash")+
  geom_hline(yintercept = -0.5, linetype = "dotdash")+
  scale_y_continuous(breaks = seq(0, 6.5, 0.5), expand = c(0, 0), limits = c(0, NA))

p_MC_Dev_in = ggdraw() +
  draw_plot(p_MC_Dev + theme(legend.position="none", plot.title = element_blank())+
              geom_hline(yintercept = 0.5, linetype = "dotdash")+
              scale_y_continuous(breaks = seq(0, 6.5, 0.5), expand = c(0, 0), limits = c(0, NA)))+
  draw_plot(p_MC_Dev_in + xlim(0, 45), x = 0.35, y = 0.5, width = .6, height = .4)+
  scale_y_continuous(breaks = seq(0, 6.5, 0.5), expand = c(0, 0), limits = c(0, NA))

# Figure 1
Fig1 = plot_grid(p_MC_RSE_in + theme(legend.position="none", plot.title = element_blank()),
                 p_MC_Dev_in + theme(legend.position="none", plot.title = element_blank())+
                   scale_y_continuous(expand = c(0, 0), limits = c(0, NA)),
                 labels = c('(a)', '(b)'), ncol = 2, label_x = -0.02)
legend = get_legend(p_MC_RSE + theme(legend.box.margin = margin(0, 0, 0, 12,),
                                     legend.title = element_text(size = 14, colour = "black", face = "bold"),
                                     legend.text = element_text(size = 12, face ="bold", colour ="black"),))
plot_grid(Fig1, legend, rel_widths = c(3, 0.3))

```

## Sequential vs random 40 frames
```{r eval = TRUE, echo=T, message=F, warning=F}
# 9 MeanCounts from 9 unique sets of 40 frames which was sub-sampled from 360 intensively sampled frames (S10)
Seq40 = data.frame(Aukane = rep(0, 9), 
                   Chicken = rep(0, 9),
                   Heron = rep(0, 9))
# 9 sets of random frames
Ran40 = Seq40

# Mean of the 9 MeanCounts from 9 sets of random 40 frames, repeat 1,000 times
MC40_mean = data.frame(Aukane = rep(0, 1000), 
                   Chicken = rep(0, 1000),
                   Heron = rep(0, 1000))
# RSE of the 9 MeanCounts from 9 sets of random 40 frames, repeat 1,000 times
MC40_RSE = MC40_mean

# Generate empty list for storing sequentially sampled 40 frames at each site
dfc_S90 = list(vector(mode = "list", length = 9), vector(mode = "list", length = 9), vector(mode = "list", length = 9))

# Subsampling 40 frames sequentially and compute MeanCount
for (n in 1:3) {  
  # Sample size = 40 frames
  # No. of sample: 9
  for (i in 1:9) {
    dfc_S90[[n]][[i]] = dfc[[n]][seq(i, 360, 9),] # subsample a unqiue set of sequential 40 frames
    Seq40[i, n] = mean(rowSums(dfc_S90[[n]][[i]])) # MeanCount from a set of sequential 40 frames
  }
}

# mean of 9 MeanCounts from nine unique sets of 40 sequential frames
Seq40_mean = apply(Seq40, MARGIN = 2, FUN = mean)
# RSE of MeanCount from nine sets of 40 sequential frames
Seq40_RSE = apply(Seq40, MARGIN = 2, FUN = RSE)

# Subsampling 40 frames randomly, compute MeanCount, and bootstrapping for 1,000 times
set.seed(123)
for (n in 1:3) {   
  for (j in 1:1000) {
    for (i in 1:9) {
      rrs = sample(1:360, size = 40, replace = T) # randomly select 40 frames
      Ran40[i, n] = mean(rowSums(dfc[[n]][rrs,])) # MeanCount for each set of sub-sampled 40 random frames at each site
    }
    MC40_RSE[j, n] = RSE(Ran40[, n]) # RSE of the 9 MeanCounts from 9 sets of random 40 frames
    MC40_mean[j, n] = mean(Ran40[, n]) # Mean of the 9 MeanCounts from 9 sets of random 40 frames
  }}
rm(Ran40)

# sort RSE & Mean from low to high values
MC40_RSE = apply(MC40_RSE, MARGIN = 2, FUN = sort) %>% as.data.frame()
MC40_mean = apply(MC40_mean, MARGIN = 2, FUN = sort) %>% as.data.frame()

# Mean of the 1,000 bootstrapped RSE
apply(MC40_RSE, MARGIN = 2, FUN = mean)
# Mean of the 1,000 bootstrapped MeanCount
apply(MC40_mean, MARGIN = 2, FUN = mean)
```

### Plotting
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 10, fig.width = 15}
# Generate empty list for storing plots
p_MC40_RSE = vector("list", 3)
names(p_MC40_RSE) = S3
p_MC40_mean = p_MC40_RSE

for (n in 1:3) {
  # Histograms of RSE of the 1,000 bootstrapped MeanCount
  p_MC40_RSE[[n]] = ggplot(MC40_RSE, aes(x = .data[[names(p_MC40_RSE)[n]]]))+
    geom_histogram(color="black", fill = col3[n])+
    theme(plot.title = element_text(face = "bold", size = (15), hjust = 0.5),
          axis.text = element_text(colour = "black", face = "bold", size = 12),
          axis.title = element_text(face = "bold", size = 14, colour = "black"), 
          panel.background = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2))+
    geom_vline(xintercept = c(MC40_RSE[25, n], MC40_RSE[975, n]))+ # add CI
    geom_vline(xintercept = Seq40_RSE[n], col = "#b2182b", linewidth = 2)+
    labs(x = "RSE (%)", y = "Count", title = names(p_MC40_RSE)[[n]])+
    scale_y_continuous(breaks = c(seq(0, 90, 30)), limits = c(0, 110))
  # Histograms of mean of the 1,000 bootstrapped MeanCount
  p_MC40_mean[[n]] = ggplot(MC40_mean, aes(x = .data[[names(p_MC40_mean)[n]]]))+
    geom_histogram(color="black", fill = col3[n])+
    theme(plot.title = element_text(face = "bold", size = (15), hjust = 0.5),
          axis.text = element_text(colour = "black", face = "bold", size = 12),
          axis.title = element_text(face = "bold", size = 14, colour = "black"), 
          panel.background = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2))+
    geom_vline(xintercept = c(MC40_mean[25, n], MC40_mean[975, n]))+ # add CI
    geom_vline(xintercept = Seq40_mean[n], col = "#b2182b", linewidth = 2)+
    labs(x = "Average MeanCount", y = "Count", title = names(p_MC40_mean)[[n]])+
    scale_y_continuous(breaks = c(seq(0, 90, 30)), limits = c(0, 110))
}

Fig2_1 = plot_grid(p_MC40_RSE[[1]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   p_MC40_RSE[[2]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   p_MC40_RSE[[3]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   ncol = 3, nrow = 1, labels = c('(a)', '(b)', '(c)'), label_x = -0.015)

Fig2_1x = annotate_figure(Fig2_1, bottom = textGrob("RSE (%)", gp = gpar(cex = 1.3, fontface = "bold")))

Fig2_2 = plot_grid(p_MC40_mean[[1]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   p_MC40_mean[[2]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   p_MC40_mean[[3]] + rremove("ylab") + rremove("xlab") + theme(plot.title = element_blank()),
                   ncol = 3, nrow = 1, labels = c('(d)', '(e)', '(f)'), label_x = -0.015)

Fig2_2x = annotate_figure(Fig2_2, bottom = textGrob("Average MeanCount", gp = gpar(cex = 1.3, fontface = "bold")))

# Figure 2
annotate_figure(plot_grid(Fig2_1x, Fig2_2x, ncol = 1, nrow = 2), left = textGrob("Frequency", rot = 90, gp = gpar(cex = 1.3, fontface = "bold")))
```


## Explore species richness
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 5.5, fig.width = 15}
# Create empty lists for different sampling intervals
SubS_c = vector("list", length = 3) # raw counts
SubS_r = vector("list", length = 3) # richness
# Create an empty list for storing rarefaction values
out = SubS_c
# Set the min and max sampling effort
m = c(1:360)

# Compute interpolation & extrapolation for species accumulation curves
for (n in 1:3) {
  # Sub-sample data in different sampling intervals
  SubS_r[[n]] = list(
    S10 = as.matrix(t(dfc_r[[n]])), # Sampling every 10 sec (S10)
    S30 = as.matrix(t(dfc_r[[n]][seq(1, 360, 3),])), # Sampling every 30 sec (S30)
    S60 = as.matrix(t(dfc_r[[n]][seq(1, 360, 6),])), # Sampling every 60 sec (S60)
    S90 = as.matrix(t(dfc_r[[n]][seq(1, 360, 9),])) # Sampling every 90 sec (S90)
  )
  SubS_c[[n]] = list(
    S10 = as.matrix(t(dfc[[n]])), # Sampling every 10 sec (S10)
    S30 = as.matrix(t(dfc[[n]][seq(1, 360, 3),])), # Sampling every 30 sec (S30)
    S60 = as.matrix(t(dfc[[n]][seq(1, 360, 6),])), # Sampling every 60 sec (S60)
    S90 = as.matrix(t(dfc[[n]][seq(1, 360, 9),])) # Sampling every 90 sec (S90)
  )
  # Generate species accumulation curves
  out[[n]] = iNEXT(SubS_r[[n]], q = 0, datatype = "incidence_raw", size = m)
}

# Richness coverage (x-axis: actual time of the video)
out_time = vector("list", length = 3)
names(out_time) = S3
SRC_time = out_time
col12 = c("#b35806", "#c47226", "#d68e46", "#e7aa66",
         "#998ec3", "#b2a6d3", "#cbc0e3", "#e5d9f3",
         "#542788", "#6f3ea0", "#8b56b8", "#a770d0")

for (n in 1:3) {
  # Extract the interpolation data
  out_time[[n]] = out[[n]][["iNextEst"]]$coverage_based[which(out[[n]][["iNextEst"]]$coverage_based$Method != "Extrapolation"),]
  # Covert absolute species richness to richness coverage
  out_time[[n]]$per = round(out_time[[n]]$qD/max(out_time[[n]]$qD)*100, 2)
  # Change frame to actual video time
  out_time[[n]]$time = c(seq(10, 3600, 10), seq(30, 3600, 30), seq(60, 3600, 60), seq(90, 3600, 90))
  # plotting
  SRC_time[[n]] = ggplot(out_time[[n]], aes(x = time, y = per, color = Assemblage))+
    theme(plot.title = element_text(face = "bold", size = (15), hjust = 0.5),
          axis.text = element_text(colour = "black", face = "bold", size = 12),
          axis.title = element_text(face = "bold", size = 14, colour = "black"), 
          panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
          legend.title = element_text(size = 10, colour = "black", face = "bold"),
          legend.text = element_text(size = 10, face ="bold", colour ="black"),
          legend.position="bottom",
          legend.key=element_blank())+
    geom_point(size = 2)+
    geom_line()+
    labs(x = "Time (s)", y = "Richness coverage (%)", color = "Sampling interval")+
    scale_color_manual(values = col12[(4*n-3):(4*n)])+
    scale_y_continuous(breaks=seq(0,100,10))+
    scale_x_continuous(breaks=seq(0,3600,600))+
    annotate("text", label = str_c("Richness: ", as.character(max(out_time[[n]]$qD)), sep = ""), 
             x = 2700, y = 15, size = 4, hjust = 0, color = col3[n])+
    annotate("text", label = str_c("Site: ", names(SRC_time)[[n]], sep = ""),
             x = 2700, y = 20, size = 4, hjust = 0, color = col3[n])
}

# Figure 3
Fig3 = plot_grid(SRC_time[[1]], SRC_time[[2]], SRC_time[[3]], 
                 ncol = 3, nrow = 1, labels = c('(a)', '(b)', '(c)'), label_x = -0.02)
Fig3
```

# **Optimizing sampling for corallivorous bite rates**
## Data preparation
```{r eval = TRUE, echo=T, message=F, warning=F}
S6 = factor(c("Masig", "Lizard", "Pelorus", "Davies", "Halfway", "Heron"), levels = c("Masig", "Lizard", "Pelorus", "Davies", "Halfway", "Heron"))
col6 = c("#b35806", "#f1a340", "#fee0b6", "#998ec3","#045a8d", "#542788")

# Remove unknown prey & only keep obligate corallivores
FR_Masig = FR_Masig %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)
FR_Lizard = FR_Lizard %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)
FR_Davies = FR_Davies %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)
FR_Halfway = FR_Halfway %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)
FR_Heron = FR_Heron %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)
FR_Pelorus = FR_Pelorus %>% filter(Comment != "unknown" & Species %in% Oblcoral$Species)

# Generate empty list for storing raw data & bite rates
meta = list(
  RD = list(FR_Masig, FR_Lizard, FR_Pelorus, FR_Davies, FR_Halfway, FR_Heron), # raw data
  Site = S6,
  Species = rep(0,6), # dominat species
  CR = vector(length = 6, mode = "list"), # bite rates of all species
  CR_dom = vector(length = 6, mode = "list") # bite rates of the dominant species
)
names(meta$RD) = S6
names(meta$CR) = S6
names(meta$CR_dom) = S6

# Generate empty data frame for storing simulated data of precision and accuracy of the mean bite rate from the first 10 mins and every following 30 s
dp = data.frame(
  Time = rep(seq(10, 60, 0.5), 6),
  RSE = rep(0, 606),
  Mean = rep(0, 606),
  RSE_dom = rep(0, 606),
  Mean_dom = rep(0, 606),
  Site = rep(S6, each = 101),
  FE = rep(0, 606), # feeding events of all species
  FE_dom = rep(0, 606) # feeding events of the dominant species
)
```

## How long/how many should the video/feeding events be?
```{r eval = TRUE, echo=T, message=F, warning=F}
for (n in 1:6) {
  
  # Find the dominant species
  meta$Species[n] = ifelse(
    length(table(meta$RD[[n]]$Species)) == 1,
    row.names(table(meta$RD[[n]]$Species)),
    rownames(sort(table(meta$RD[[n]]$Species), decreasing = T))[1]
  )
  
  # Count the no. of bites of each individual on every prey
  df = meta$RD[[n]] %>% group_by(Genus, Species, Activity, TL, ID, Comment) %>%
    mutate(Bite = n())
  
  # Calculate the observation time for each feeding event
  FB = df %>% filter(Activity == "Passing") %>% group_by(Genus, Species, Comment, TL, ID) %>% 
    cast(., Family + Genus + Species + TL + ID ~ Comment, value = "Time") %>%
    mutate(Obs = `time out`-`time in`)
  
  # Calculate bite rates
  prey = df %>% filter(Activity == "Feeding") %>% group_by(Family, Genus, Species, TL, ID) %>% 
    select(-c(Time, Comment)) %>% unique() %>% left_join(., FB) %>% mutate(CR = Bite/Obs)
  
  meta$CR[[n]] = na.omit(prey)
  meta$CR_dom[[n]] = prey %>% filter(Species == meta$Species[n])
  
  # Calculate mean & RSE of bites as time increases from 10 min and every 30 s after
  for (i in seq(10, 60, 0.5)) {
    # Mean bite rates of all species
    prey %>% filter(`time out` <= i) %>% pull(CR) %>% mean() -> dp$Mean[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
    # RSE of the bite rates of all species
    prey %>% filter(`time out` <= i) %>% pull(CR) %>% RSE() -> dp$RSE[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
    # Mean bite rates of the dominant species
    prey %>% filter(Species == meta$Species[n] & `time out` <= i) %>% pull(CR) %>% mean(., na.rm = T) -> dp$Mean_dom[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
    # RSE of the bite rates of the dominant species
    prey %>% filter(Species == meta$Species[n] & `time out` <= i) %>% pull(CR) %>% RSE() -> dp$RSE_dom[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
    # Number of feeding events of all species
    prey %>% filter(`time out` <= i) %>% nrow() -> dp$FE[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
    # Number of feeding events of the dominant species
    prey %>% filter(Species == meta$Species[n] & `time out` <= i) %>% nrow() -> dp$FE_dom[(1:101)+(101*(n-1))][which(seq(10, 60, 0.5) == i)]
  }
}

# Calculate accuracy: (Truth - Estimate)/Estimate*100%
dp = na.omit(dp)
dp_T = dp %>% filter(Time == 60) %>% select(Site, Mean, Mean_dom)
colnames(dp_T)[2:3] = c("Mean_60", "Mean_dom_60")

dp = dp %>% left_join(., dp_T) %>% mutate(Accuracy = (Mean_60-Mean)/Mean_60*100,
                                          Accuracy_dom = (Mean_dom_60-Mean_dom)/Mean_dom_60*100)

# Calculate RSE & devitions for Mean bite rates with increasing feeding events
dp_CR = vector(mode = "list", length = 6)
names(dp_CR) = meta$Site

for (j in 1:6) {
  
  dp_CR[[j]] = data.frame(
    NofEve = 2:nrow(meta[["CR"]][[j]]),
    Mean = rep(0, nrow(meta[["CR"]][[j]])-1),
    RSE = rep(0, nrow(meta[["CR"]][[j]])-1),
    Dev = rep(0, nrow(meta[["CR"]][[j]])-1)
  )
  
  for (n in 2:nrow(meta[["CR"]][[j]])) {
    
    dp_CR[[j]]$NofEve[n-1] = n
    dp_CR[[j]]$Mean[n-1] = mean(meta[["CR"]][[j]]$CR[1:n])
    dp_CR[[j]]$RSE[n-1] = meta[["CR"]][[j]]$CR[1:n] %>% RSE
    dp_CR[[j]]$Dev[n-1] = abs(mean(meta[["CR"]][[j]]$CR[1:n]) - dp_T$Mean_60[j]) / dp_T$Mean_60[j]*100
    
  }  
}

dp_CR = bind_rows(dp_CR, .id = "Site")
dp_CR$Site = factor(dp_CR$Site, levels = meta$Site)

dp_CR_dom = vector(mode = "list", length = 6)
names(dp_CR_dom) = meta$Site


for (j in 1:6) {
  
  dp_CR_dom[[j]] = data.frame(
    NofEve = 2:nrow(meta[["CR_dom"]][[j]]),
    Mean = rep(0, nrow(meta[["CR_dom"]][[j]])-1),
    RSE = rep(0, nrow(meta[["CR_dom"]][[j]])-1),
    Dev = rep(0, nrow(meta[["CR_dom"]][[j]])-1)
  )
  
  for (n in 2:nrow(meta[["CR_dom"]][[j]])) {
    
    dp_CR_dom[[j]]$NofEve[n-1] = n
    dp_CR_dom[[j]]$Mean[n-1] = mean(meta[["CR_dom"]][[j]]$CR[1:n])
    dp_CR_dom[[j]]$RSE[n-1] = meta[["CR_dom"]][[j]]$CR[1:n] %>% RSE
    dp_CR_dom[[j]]$Dev[n-1] = abs(mean(meta[["CR_dom"]][[j]]$CR[1:n]) - dp_T$Mean_60[j]) / dp_T$Mean_60[j]*100
    
  }  
}

dp_CR_dom = bind_rows(dp_CR_dom, .id = "Site")
dp_CR_dom$Site = factor(dp_CR_dom$Site, levels = meta$Site)
```

### Plotting
#### As analyzed length of videos increases
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 9, fig.width = 12}
# Precision of all species
p_FR_P_all = ggplot(dp, aes(x = Time, y = RSE, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "RSE (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  scale_x_continuous(limits = c(10,60), breaks = seq(10,60,10))+
  geom_vline(xintercept = 30, linetype="dashed")+
  geom_hline(yintercept = 20, linetype="dashed")+
  scale_y_continuous(breaks = seq(5,45,5))
# Accuracy of all species
p_FR_A_all = ggplot(dp, aes(x = Time, y = abs(Accuracy), col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "Absolute deviation (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  scale_x_continuous(limits = c(10,60), breaks = seq(10,60,10))+
  scale_y_continuous(breaks = c(10, seq(0, 125, 25)))+
  #geom_vline(xintercept = 30)+
  geom_hline(yintercept = 10, linetype="dashed")+
  geom_vline(xintercept = 30, linetype="dashed")
# Precision of the dominant species
p_FR_P_dom = ggplot(dp, aes(x = Time, y = RSE_dom, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "RSE (%)")+
  scale_color_manual(values = col6)+
  geom_line(linewidth = 1) + #geom_point()+
  scale_x_continuous(limits = c(10,60), breaks = seq(10,60,10))+
  geom_vline(xintercept = 30, linetype="dashed")+
  geom_hline(yintercept = 20, linetype="dashed")+
  scale_y_continuous(breaks = seq(5,45,5))
# Accuracy of the dominant species
p_FR_A_dom = ggplot(dp, aes(x = Time, y = abs(Accuracy_dom), col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "Absolute deviation (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  scale_x_continuous(limits = c(10,60), breaks = seq(10,60,10))+
  scale_y_continuous(breaks = c(10, seq(0, 125, 25)))+
  #geom_vline(xintercept = 30)+
  geom_hline(yintercept = 10, linetype="dashed")+
  geom_vline(xintercept = 30, linetype="dashed")

Fig4_T = plot_grid(p_FR_P_all+ theme(legend.position="none"),
                   p_FR_A_all+ theme(legend.position="none"),
                   ncol = 2, nrow = 1, labels = c('(a)', '(b)'), label_x = -0.02)
Fig4_T = ggdraw() + 
  draw_plot(Fig4_T, x = 0.05, y = 0.05, width = 0.9, height = 0.9)+
  theme(plot.margin = margin(0, 0, 0, 20),
        panel.border = element_rect(colour = "lightgrey", fill=NA, linewidth = 2))
Fig4_T = annotate_figure(Fig4_T, left = textGrob("All corallivorous fish", gp = gpar(cex = 1.3, fontface = "bold", col = "#7B9098"), rot = 90))

Fig4_T = ggdraw() + 
  draw_plot(Fig4_T, x = 0.05, y = 0.05, width = 0.9, height = 0.9)

Fig4_B = plot_grid(p_FR_P_dom+ theme(legend.position="none"),
                   p_FR_A_dom+ theme(legend.position="none"),
                   ncol = 2, nrow = 1, labels = c('(c)', '(d)'), label_x = -0.02)
Fig4_B = ggdraw() + 
  draw_plot(Fig4_B, x = 0.05, y = 0.05, width = 0.9, height = 0.9)+
  theme(plot.margin = margin(0, 0, 0, 20),
        panel.border = element_rect(colour = "lightgrey", fill=NA, linewidth = 2))

Fig4_B = annotate_figure(Fig4_B, left = textGrob("Dominant species", gp = gpar(cex = 1.3, fontface = "bold", col = "#7B9098"), rot = 90))
Fig4_B = ggdraw() + 
  draw_plot(Fig4_B, x = 0.05, y = 0.05, width = 0.9, height = 0.9)

Fig4 = ggarrange(Fig4_T, Fig4_B, ncol = 1)

legend =  get_legend(
  # create some space to the left of the legend
  p_FR_P_all + theme(legend.box.margin = margin(0, 0, 0, 10))
)
# Figure 4
plot_grid(Fig4, legend, ncol = 2, rel_widths = c(9, 1.4))
```

#### As feeding events increases
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 6, fig.width = 13}
# Accumulative feeding events through time across species
FigS2_L = ggplot(dp, aes(x = Time, y = FE, col = Site))+
  theme(
        axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "Feeding events of all species")+
  geom_line(linewidth = 1)+
  scale_color_manual(values = col6)+
  scale_x_continuous(limits = c(0,60), breaks = seq(0,60,10))+
  scale_y_continuous(limits = c(0,60), breaks = seq(0,60,10))+
  geom_hline(yintercept = 15, linetype="dashed")+
  geom_vline(xintercept = 30, linetype="dashed")
# Accumulative feeding events through time of the dominant species
FigS2_R = ggplot(dp, aes(x = Time, y = FE_dom, col = Site))+
  theme(
        axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Video length analyzed (min)", y = "Feeding events of the dominant species")+
  geom_line(linewidth = 1)+
  scale_color_manual(values = col6)+
  scale_x_continuous(limits = c(0,60), breaks = seq(0,60,10))+
  scale_y_continuous(limits = c(0,60), breaks = seq(0,60,10))+
  geom_hline(yintercept = 15, linetype="dashed")+
  geom_vline(xintercept = 30, linetype="dashed")

# Figure S2
legend = get_legend(
  FigS2_L + theme(legend.box.margin = margin(0, 0, 0, 10))
)
plot_grid(FigS2_L + theme(legend.box.margin = margin(0, 0, 0, 10),
                          legend.position = "none"),
          FigS2_R + theme(legend.box.margin = margin(0, 0, 0, 10),
          legend.position = "none"),
          legend, ncol = 3, rel_widths = c(10, 10, 2), labels = c("(a)", "(b)"))
```

```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 9, fig.width = 12}
# Precision of all species
p_FR_P_all_FE = ggplot(dp_CR, aes(x = NofEve, y = RSE, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Feeding events", y = "RSE (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  geom_hline(yintercept = 20, linetype="dashed")+
  geom_vline(xintercept = 15, linetype="dashed")+
  scale_y_continuous(breaks = seq(0,60,10))+
  scale_x_continuous(breaks = seq(0,60,15))

# Accuracy of all species
p_FR_A_all_FE = ggplot(dp_CR, aes(x = NofEve, y = Dev, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Feeding events", y = "Absolute deviation (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  scale_y_continuous(breaks = c(10, seq(0, 125, 25)))+
  scale_x_continuous(breaks = seq(0,60,15))+
  #geom_vline(xintercept = 15)+
  geom_hline(yintercept = 10, linetype="dashed")+
  geom_vline(xintercept = 15, linetype="dashed")

# Precision of the dominant species
p_FR_P_all_FE_dom = ggplot(dp_CR_dom, aes(x = NofEve, y = RSE, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"), 
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Feeding events", y = "RSE (%)")+
  scale_color_manual(values = col6)+
  geom_line(linewidth = 1)+
  geom_hline(yintercept = 20, linetype="dashed")+
  geom_vline(xintercept = 15, linetype="dashed")+
  scale_y_continuous(breaks = seq(0,60,10))+
  scale_x_continuous(breaks = seq(0,60,15))

# Accuracy of the dominant species
p_FR_A_all_FE_dom = ggplot(dp_CR_dom, aes(x = NofEve, y = Dev, col = Site))+
  theme(axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_text(size = 14, colour = "black", face = "bold"),
        legend.text = element_text(size = 12, face ="bold", colour ="black"), 
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  labs(x = "Feeding events", y = "Absolute deviation (%)")+
  geom_line(linewidth = 1) + #geom_point()+
  scale_color_manual(values = col6)+
  scale_y_continuous(breaks = c(10, seq(0, 125, 25)))+
  scale_x_continuous(breaks = seq(0,60,15))+
  #geom_vline(xintercept = 15)+
  geom_hline(yintercept = 10, linetype="dashed")+
  geom_vline(xintercept = 15, linetype="dashed")

Fig5_T = plot_grid(p_FR_P_all_FE+ theme(legend.position="none"),
                   p_FR_A_all_FE+ theme(legend.position="none"),
                   ncol = 2, nrow = 1, labels = c('(a)', '(b)'), label_x = -0.02)
Fig5_T = ggdraw() + 
  draw_plot(Fig5_T, x = 0.05, y = 0.05, width = 0.9, height = 0.9)+
  theme(plot.margin = margin(0, 0, 0, 20),
        panel.border = element_rect(colour = "lightgrey", fill=NA, linewidth = 2))
Fig5_T = annotate_figure(Fig5_T, left = textGrob("All corallivorous fish", gp = gpar(cex = 1.3, fontface = "bold", col = "#7B9098"), rot = 90))

Fig5_T = ggdraw() + 
  draw_plot(Fig5_T, x = 0.05, y = 0.05, width = 0.9, height = 0.9)

Fig5_B = plot_grid(p_FR_P_all_FE_dom+ theme(legend.position="none"),
                   p_FR_A_all_FE_dom+ theme(legend.position="none"),
                   ncol = 2, nrow = 1, labels = c('(c)', '(d)'), label_x = -0.02)
Fig5_B = ggdraw() + 
  draw_plot(Fig5_B, x = 0.05, y = 0.05, width = 0.9, height = 0.9)+
  theme(plot.margin = margin(0, 0, 0, 20),
        panel.border = element_rect(colour = "lightgrey", fill=NA, linewidth = 2))

Fig5_B = annotate_figure(Fig5_B, left = textGrob("Dominant species", gp = gpar(cex = 1.3, fontface = "bold", col = "#7B9098"), rot = 90))
Fig5_B = ggdraw() + 
  draw_plot(Fig5_B, x = 0.05, y = 0.05, width = 0.9, height = 0.9)

Fig5 = ggarrange(Fig5_T, Fig5_B, ncol = 1)

legend =  get_legend(
  # create some space to the left of the legend
  p_FR_P_all_FE_dom + theme(legend.box.margin = margin(0, 0, 0, 10))
)
# Figure 5
plot_grid(Fig5, legend, ncol = 2, rel_widths = c(9, 1.4))
```

## Summary statistics of feeding activities
```{r eval = TRUE, echo=T, message=F, warning=F, fig.height = 4, fig.width = 8}
# Summary statistics of bite rates of all species
Summ_BR = data.frame(Mean = rep(0, 6), SE = rep(0, 6), RSE = rep(0, 6),
                     Obs = rep(0, 6), Obs_SE = rep(0, 6))
rownames(Summ_BR) = S6

for (n in 1:6) {
  Summ_BR[n, 1] = meta$CR[[n]]$CR %>% mean() %>% round(., 2)
  Summ_BR[n, 2] = meta$CR[[n]]$CR %>% SE() %>% round(., 2)
  Summ_BR[n, 3] = meta$CR[[n]]$CR %>% RSE() %>% round(., 2)
  Summ_BR[n, 4] = meta$CR[[n]]$Obs %>% mean() %>% round(., 2)
  Summ_BR[n, 5] = meta$CR[[n]]$Obs %>% SE() %>% round(., 2)
}

Summ_BR$N = lapply(meta$CR, nrow) %>% unlist()
Summ_BR$Richness = lapply(meta$CR, "[", , "Species") %>% lapply(., unique) %>% lapply(., nrow) %>% unlist()

# Summary statistics of bite rates of dominant species
Summ_BR_dom = data.frame(Mean = rep(0, 6), SE = rep(0, 6), RSE = rep(0, 6),
                         Obs = rep(0, 6), Obs_SE = rep(0, 6))
rownames(Summ_BR_dom) = meta$Site
for (n in 1:6) {
  Summ_BR_dom[n, 1] = meta$CR_dom[[n]]$CR %>% mean(., na.rm = T) %>% round(., 2)
  Summ_BR_dom[n, 2] = meta$CR_dom[[n]]$CR %>% SE() %>% round(., 2)
  Summ_BR_dom[n, 3] = meta$CR_dom[[n]]$CR %>% RSE() %>% round(., 2)
  Summ_BR_dom[n, 4] = meta$CR_dom[[n]]$Obs %>% mean(., na.rm = T) %>% round(., 2)
  Summ_BR_dom[n, 5] = meta$CR_dom[[n]]$Obs %>% SE() %>% round(., 2)
}
Summ_BR_dom$N = lapply(na.omit(meta$CR_dom), nrow) %>% unlist()

# Table 2
Table2 = data.frame(`No. of feeding events_all` = rep(0,6),
                    `Bite rates_all` = rep(0,6),
                    `Event duration_all` = rep(0,6),
                    `No. of feeding events_dom` = rep(0,6),
                    `Bite rates_dom` = rep(0,6),
                    `Event duration_dom` = rep(0,6))
rownames(Table2) = meta$Site
Table2$No..of.feeding.events_all = Summ_BR$N
Table2$No..of.feeding.events_dom = Summ_BR_dom$N
Table2$Bite.rates_all = str_c(Summ_BR$Mean, Summ_BR$SE, sep = " ± ")
Table2$Bite.rates_dom = str_c(Summ_BR_dom$Mean, Summ_BR_dom$SE, sep = " ± ")
Table2$Event.duration_all = str_c(Summ_BR$Obs, Summ_BR$Obs_SE, sep = " ± ")
Table2$Event.duration_dom = str_c(Summ_BR_dom$Obs, Summ_BR_dom$Obs_SE, sep = " ± ")

Table2

# Bite rates of corallivores across sites
BR_F15 = bind_rows(meta[["CR"]], .id = "Site") %>% group_by(Site) %>% mutate(Event = 1:n())
BR_F15$F15E = ifelse(BR_F15$Event <= 15, "F15", "F16+")
BR_F15$Site = factor(BR_F15$Site, levels = levels(meta$Site))

# Figure S3
FigS3 = ggplot(data = BR_F15, aes(x = Site, y = CR))+
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14, hjust = 0.5),
        axis.text = element_text(colour = "black", face = "bold", size = 12), 
        axis.title = element_text(face = "bold", size = 14, colour = "black"),
        legend.title = element_blank(),
        legend.text = element_text(size = 12, face ="bold", colour ="black"),
        panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank(), legend.position = "right")+
  geom_boxplot()+
  geom_jitter(aes(col = F15E), shape = 17)+
  scale_color_discrete(labels = c("The first 15 events", "All others"))+
  labs(x = NULL, y = "Bite rates (bites per min)")
FigS3

```



